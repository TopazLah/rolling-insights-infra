# אליאס: /api/watcher/* -> Watcher Bridge ב־127.0.0.1:5151
location /api/watcher/ {
    proxy_pass         http://127.0.0.1:5151/;   # חשוב: '/' בסוף לשימור המסלול
    proxy_http_version 1.1;

    # מונעים 404 פנימי כי האפליקציה מצפה ל־Host לוקאלי
    proxy_set_header   Host               127.0.0.1;
    proxy_set_header   X-Real-IP          $remote_addr;
    proxy_set_header   X-Forwarded-For    $proxy_add_x_forwarded_for;
    proxy_set_header   X-Forwarded-Proto  $scheme;

    # הסתר כותרות CORS שמגיעות מהאפליקציה כדי למנוע כפילויות
    proxy_hide_header  Access-Control-Allow-Origin;
    proxy_hide_header  Access-Control-Allow-Methods;
    proxy_hide_header  Access-Control-Allow-Headers;
    proxy_hide_header  Access-Control-Allow-Credentials;
    proxy_hide_header  Vary;

    # CORS (מנוהל ע"י Nginx)
    add_header         Access-Control-Allow-Origin "https://rolling-insights-ui.web.app" always;
    add_header         Vary "Origin" always;
    add_header         Access-Control-Allow-Credentials "true" always;
    add_header         Access-Control-Allow-Methods "GET,PUT,POST,DELETE,OPTIONS" always;
    add_header         Access-Control-Allow-Headers "Content-Type, Authorization, X-Bridge-Key" always;
    if ($request_method = OPTIONS) { return 204; }

    # SSE / stream
    proxy_buffering off;
    proxy_read_timeout 1h;
    chunked_transfer_encoding off;
    proxy_set_header   Connection "";
    proxy_set_header   Accept-Encoding "";
}
